'use strict';

const { Color, url_for } = require('hexo-util');
const { default: moize } = require('moize');
const { team } = require('./team');

function tagcloudHelper(tags, options) {
    
  if (!options && (!tags || !Object.prototype.hasOwnProperty.call(tags, 'length'))) {
    options = tags;
    tags = this.site.tags;
  }

  if (!tags || !tags.length) return '';
  options = options || {};

  const min = options.min_font || 10;
  const max = options.max_font || 20;
  const orderby = options.orderby || 'name';
  const order = options.order || 1;
  const unit = options.unit || 'px';
  const color = options.color;
  const className = options.class;
  const showCount = options.show_count;
  const countClassName = options.count_class || 'count';
  const level = options.level || 10;
  const { transform } = options;
  const separator = options.separator || ' ';
  const result = [];
  
  try{
  //十八个闪耀瞬间
  //tags.push([{"length":17},{"name":"十八个闪耀瞬间"},{"path":"/%E5%8D%81%E5%85%AB%E4%B8%AA%E9%97%AA%E8%80%80%E7%9E%AC%E9%97%B4/"}]);

  // Sort the tags
  if (orderby === 'random' || orderby === 'rand') {
    tags = tags.random();
  } else {
    tags = tags.sort(orderby, order);
  }
  
  // Limit the number of tags
  if (options.amount) {
    tags = tags.limit(options.amount);
  }

  const sizes = [];

  tags.sort('length').forEach(tag => {
    const { length } = tag;
    if (sizes.includes(length)) return;

    sizes.push(length);
  });

  const length = sizes.length - 1;

  tags.forEach(tag => {
    const ratio = length ? sizes.indexOf(tag.length) / length : 0;
    const size = min + ((max - min) * ratio);
    let style = `font-size: ${parseFloat(size.toFixed(2))}${unit};`;
    var attr = ""
    
    if(tag.name === "十八个闪耀瞬间"){
     attr = className ? ` class="${className}-${Math.round(ratio * level)} snh_group"` : '';
    }
    else{
     attr = className ? ` class="${className}-${Math.round(ratio * level)} ${(tag.name.indexOf("十八个闪耀瞬间") == -1)  ? "" : "_18s "}${(tag.name.indexOf("EP") == 0) ? "ep " : ""}${team(tag.name)[0]}"` : '';
        
    }
    
    result.push(
      `<a href="${url_for.call(this, tag.path)}" style="${style}"${attr}>${transform ? transform(tag.name) : tag.name}${showCount ? `<span class="${countClassName}">${tag.length}</span>` : ''}</a>`
    );
  });
  
  return result.join(separator);
  }
  catch(e){
      return e.message;
  }
}

function tagcloudHelperFactory(tags, options) {
  const transformArgs = () => {
    if (!options && (!tags || !Object.prototype.hasOwnProperty.call(tags, 'length'))) {
      options = tags;
      tags = this.site.tags;
    }

    return [tags.toArray(), options];
  };

  return moize(tagcloudHelper.bind(this), {
    maxSize: 5,
    isDeepEqual: true,
    transformArgs
  }).call(this, tags, options);
}

module.exports = tagcloudHelperFactory;
